name: Docs Validation

on:
  pull_request:
    branches: [dev, main]
    paths:
      - 'docs/**'
      - 'scripts/**'
      - '.github/workflows/docs-validation.yml'

jobs:
  validate-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    # ----------------------------------
    # åŸºç¡€ç¯å¢ƒé…ç½®
    # ----------------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Install dependencies
      run: npm install js-yaml@4 chalk@4

    # ----------------------------------
    # æ–‡æ¡£éªŒè¯æ‰§è¡Œ
    # ----------------------------------
    - name: Run validation
      id: validation
      run: |
        set +e
        node scripts/validate-docs.cjs 2>&1 | tee validation.log
        exit_code=$?
        echo "VALIDATION_RESULT<<EOF" >> $GITHUB_ENV
        head -n 1000 validation.log >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        exit $exit_code

    # - name: Upload validation log
    #   if: always()
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: validation-${{ github.run_id }}.log
    #     path: validation.log

    # ----------------------------------
    # è¯„è®ºå†å²æ¸…ç†
    # ----------------------------------
    - name: Clean old comments
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ env.ACT && secrets.GITHUB_TOKEN || secrets.PAT_TOKEN }}
        script: |
          const MAGIC_TAG = '<!-- DOCS_VALIDATOR -->';
          const MAX_RETRY = 3;
          
          async function retryOperation(fn, attempt = 1) {
            try {
              return await fn();
            } catch (error) {
              if (attempt >= MAX_RETRY) throw error;
              await new Promise(r => setTimeout(r, 1000 * attempt));
              return retryOperation(fn, attempt + 1);
            }
          }

          try {
            // è·å–æ‰€æœ‰è¯„è®º
            const { data: comments } = await retryOperation(() => 
              github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                per_page: 100
              })
            );

            // è¿‡æ»¤å†å²è¯„è®º
            const oldComments = comments.filter(c => 
              c.user.login === 'github-actions[bot]' &&
              c.body.includes(MAGIC_TAG)
            );

            // å¹¶è¡Œåˆ é™¤æ“ä½œ
            await Promise.all(oldComments.map(comment => 
              retryOperation(() => 
                github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id
                })
              )
            ));

            console.log(`å·²æ¸…ç† ${oldComments.length} æ¡å†å²è¯„è®º`);
          } catch (error) {
            core.warning(`è¯„è®ºæ¸…ç†å¤±è´¥: ${error.message}`);
          }

    # ----------------------------------
    # åˆ›å»ºæ–°è¯„è®º
    # ----------------------------------
    - name: Create PR comment
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ env.ACT && secrets.GITHUB_TOKEN || secrets.PAT_TOKEN }}
        script: |
          const MAGIC_TAG = '<!-- DOCS_VALIDATOR -->';
          const MAX_OUTPUT = 4000;  // GitHubè¯„è®ºé•¿åº¦é™åˆ¶
          
          try {
            // è·å–å¤„ç†åçš„è¾“å‡ºå†…å®¹
            let output = process.env.VALIDATION_RESULT || 'æœªè·å–åˆ°éªŒè¯è¾“å‡º';
            output = output.slice(0, MAX_OUTPUT);
            
            // æ„å»ºæ—¥å¿—é“¾æ¥
            const runURL = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const logLink = `ğŸ“ [æŸ¥çœ‹å®Œæ•´æ—¥å¿—](${runURL})`;
            
            // æ„é€ è¯„è®ºå†…å®¹
            const commentBody = `
              ${MAGIC_TAG}
              ### ğŸ“„ æ–‡æ¡£è§„èŒƒæ£€æŸ¥ç»“æœ (è¿è¡Œæ—¶é—´: ${new Date().toISOString()})
              
              \`\`\`\n${output}\n\`\`\`
              
              ${logLink}
            
            `;

            // åˆ›å»ºè¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: commentBody
            });
            
          } catch (error) {
            core.error(`è¯„è®ºåˆ›å»ºå¤±è´¥: ${error}`);
            throw new Error('æ— æ³•åˆ›å»ºPRè¯„è®ºï¼Œè¯·æ£€æŸ¥æƒé™é…ç½®');
          }